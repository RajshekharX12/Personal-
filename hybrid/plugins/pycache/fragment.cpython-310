o
    6ÂªÃ’hâ€“O  Ã£                   @   sâ€“  d dl Z d dlZd dlZd dlZd dlZd dlmZm Z mZm	Z	 d dl
m
Z
 d dlZd dl
mZ d dlmZmZmZmZ dZeeeeB f ZeÂ eÂ¡ZejsVejejd dÂ G d	d
â€ d
eÆ’Z G d
dâ€ deÆ’Z!d=dede eef fddâ€Z"defddâ€Z#dedee fddâ€Z$	
							d>dededed ed!e%d"e	e d#e&d$e&deee e f fd%d&â€Z'dedee fd'd(â€Z(	
	)						d?dededed ed!e%d"e	e d#e&d$e&deee e f fd*d+â€Z)d=d,edefd-d.â€Z*d=d,ede&fd/d0â€Z+d=d,edefd1d2â€Z,G d3d4â€ d4Æ’Z-d=dede ee	e f fd5d6â€Z.e-ee.d
Æ’d7 e.d
Æ’d8 e.d
Æ’d9 d:ÂZ/	
				d@deded"e	e d#e&d$e&deee e f fd;d<â€Z0dS )AÃ©    N)ÃšListÃšDictÃšTupleÃšOptional)Ãš
AsyncClient)Ãš
BeautifulSoup)ÃšRequestExceptionÃš TimeoutÃšSSLErrorÃšConnectionErrorÃš38f80e92d2dbe5065bz%%(asctime)s %(levelname)s %(message)s)ÃšlevelÃšformatc                   @   Ã³   e Zd ZdZdS )ÃšFragmentAuthErrorzARaised when cookies are invalid / expired or site requires login.NÂ©Ãš__name__Ãš
__module__Ãš__qualname__Ãš __doc__Â© r   r   Ãº8/mnt/c/Users/LENOVO/RentalBot/hybrid/plugins/fragment.pyr      Ã³    r   c                   @   r   )ÃšFragmentRateLimitErrorz?Raised when server responds with 429 and we shouldn't continue.Nr   r   r   r   r   r   !   r   r   Ãº	frag.jsonÃšpathÃšreturnc                 C   sJ   t | dddÂÂ
}tÂ |Â¡}W d  Æ’ n1 sw   Y  ddâ€ |D Æ’}|S ) z9Load cookies from Chromium-style JSON export (frag.json).ÃšrÃºutf-8Â©ÃšencodingNc                 S   Ã³*   i | ]}d |v rd|v r|d  |d â€œqS Â©ÃšnameÃšvaluer   Â©Ãš.0Ãšcr   r   r   Ãš
<dictcomp>*   Ã³   * z+_load_cookies_from_file.<locals>.<dictcomp>Â©ÃšopenÃšjsonÃšload)r   ÃšfÃšrawÃš cookiesr   r   r   Ãš_load_cookies_from_file&   s
   Ã¿r1   c                   C   s   dS )NzoMozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36r   r   r   r   r   Ãš_default_user_agent-   s   r2   Ãšhtmlc                  C   sf  t | dÆ’}tÆ’ }tÂ d|jddÂÂ¡D ] }|Â |Â¡ q|Â dÂ¡D ]7}|d }tÂ  d |Â¡}|r@|Â dÂ¡} | Â 	d	Â¡s;d	|  } |Â | Â¡ |jd
d
Â}tÂ  d|Â¡}	|	rV|Â |	Â dÂ¡Â¡ q|Â d
Â¡D ]}
|
jdd
d
Â}
tÂ  d|
Â¡}|ru|Â |Â dÂ¡Â¡ q\|j
d
dÂD ]+}|j
Â Â¡ D ]#}
t
|
ttfÆ’râ€˜dÂ |
Â¡}
t
|
tÆ’rÂ¦tÂ  d|
Â¡}|rÂ¦|Â |Â dÂ¡Â¡ qÆ’q|tddâ€ |D Æ’Æ’}|S )z8Try multiple parsing strategies to find +888... numbers.Ãº
html.parserz
\+888\d{4,15}Ãº )Ãš	separatorÃº a[href]Ãšhrefz(?:/number/|\b)(\+?888\d{4,15})Ã©   Ãº+TÂ©Ãšstripr   z5.number, .tm-number, .number-item, .my-number, .phone)Ãšattrsc                  S   s   h | ]	}t Â d d|Â¡â€™qS )z\s+Ãš )ÃšreÃšsub)r&   Ãšnr   r   r   Ãš	<setcomp>\   s    z+_parse_numbers_from_html.<locals>.<setcomp>)r    Ãšsetr?   Ãš findallÃšget_textÃšaddÃšselectÃšsearchÃšgroupÃš
startswithÃšfind_allr=   ÃšvaluesÃš
isinstanceÃšlistÃštupleÃšjoinÃšstrÃšsorted)r3   ÃšsoupÃšfoundÃšmatchÃšar8   ÃšmÃšnumÃštextÃšm2Ãš	candidateÃštxtÃštagÃšattr_valÃš
normalizedr   r   r   Ãš_parse_numbers_from_html1   sF   



â‚¬â‚¬

â‚¬Ãº	r`   Ãºhttps://fragment.com/my/numbersÃ©   Ã©   Ã§333333Ã£?TFÃšcookies_fileÃšurlÃš timeoutÃš
max_retriesÃšbackoff_baseÃš
user_agentÃš
verify_sslÃš verbosec              
   C   sÃ¼  |pt Æ’ }t| Æ’}	tÂ Â¡ }
|
jÂ |	Â¡ |ddddÅ“}
d}d}
ddd dÅ“}||k Âr\|d	7 }||d
< zÃ”| r;tÂ  d
||Â¡ |
j||
|d|d
Â}|j	|d< |j	dkr|j
Â dÂ¡}d|â€º Â}||d< |rdt
|Æ’â€š|d|d	   tÂ Â¡ d  }tÂ 
d|Â¡ tÂ |Â¡ W q$|j	dv râ€d|j	â€º Â|d< td|j	â€º ÂÆ’â€š|j	dkrÃŒ|j}g dÂ¢}|Â Â¡ }d|jÂ Â¡ v sÂ·d|v sÂ·d|v rÂ¿d|v rÂ¿d|d< td Æ’â€št|Æ’}d!|d< ||fW S d"|j	  krÃ—d#k rÃ¶n n|d|d	   tÂ Â¡ d  }tÂ 
d$|j	|Â¡ tÂ |Â¡ W q$d%|j	â€º Â|d< td%|j	â€º ÂÆ’â€š tttfÂy8 } z#|}
|d|d	   tÂ Â¡ d  }tÂ 
d&|||Â¡ tÂ |Â¡ W Y d}~q$d}~w t
Ây@   â€š  tÂyH   â€š  tÂy[ } z tÂ d'|Â¡ â€š d}~ww d(|â€º d)Â|d< |
Ârqtd*|â€º d+|
â€º ÂÆ’â€štd*|â€º d,|Â dÂ¡â€º ÂÆ’â€š)-a
  
    Fetch and return list of +888 numbers from fragment.com/my/numbers.

    Returns:
        (numbers_list, meta)
        - numbers_list: List[str] (deduplicated, normalized)
        - meta: dict with information about status, attempts, last_status_code, message
    Raises:
        FragmentAuthError if server indicates login required / cookie invalid.
        FragmentRateLimitError if server returns 429 and Retry-After suggests waiting.
        RequestException for other network-level failures (after retries).
    Ãº?text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8Ãºen-US,en;q=0.9Ãºhttps://fragment.com/Â©Ãº
User-AgentÃšAcceptÃºAccept-LanguageÃš Refererr   Nr>   Â©ÃšattemptsÃšlast_status_codeÃš messager9   rv   ÃºGET %s (attempt %d)TÂ©Ãš headersrg   Ãšallow_redirectsÃšverifyrw   Ã©Â­  Ãº
Retry-AfterÃº!Rate limited (429). Retry-After: rx   Ã©   Ã§      Ã ?z#429 received, backing off for %.1fsÂ©iâ€˜  iâ€œ  ÃºAuth failure HTTP z(Authentication/permission failure: HTTP Ã©Ãˆ   )ÃšloginÃº sign inz sign-inÃº/loginÃš	stel_ssidÃš
stel_tokenrË†   z
please logrâ€¡   Ãšpasswordu7   Detected login page Ã¢â‚¬â€ cookies may be expired/invalid.z7Detected login page. Cookies likely expired or invalid.ÃšOKÃ©Ã´  Ã©X  Ãº"Server error %d, backing off %.1fszUnexpected HTTP status: Ãµ5   Network error on attempt %d: %s Ã¢â‚¬â€ backing off %.1fszFatal request exception: %sÃº
Exhausted Ãº retriesÃº
Failed after Ãº
 attempts: z attempts: last status )r2   r1   ÃšrequestsÃš Sessionr0   ÃšupdateÃšloggerÃšinfoÃšgetÃš
status_coder{   r   ÃšrandomÃš warningÃštimeÃšsleepr   rY   Ãšlowerrf   r`   r   r
   r	   r
   Ãš	exception)re   rf   rg   rh   ri   rj   rk   rl   Ãšuar0   Ãš sessionr{   Ãš attemptÃšlast_excÃšmetaÃšrespÃš
retry_afterÃšmsgÃš	sleep_forÃšbodyÃš
login_signsrÂ    Ãš numbersÃšexcr   r   r   Ãšget_fragment_numbers`   sÅ’   
Ã»






&


â‚¬â‚¬Ã½rÂ¯   c           
      C   sÂ¼   t | dÆ’}tÆ’ }tÂ d|Â dÂ¡Â¡D ] }|Â |Â¡ q|Â dÂ¡D ]!}|jddÂ}|d  }||fD ]} | s3q.tÂ d| Â¡}|Â  |Â¡ q.q|Â dÂ¡D ]}	|	jdddÂ}
tÂ d|
Â¡}|Â  |Â¡ qEt|Æ’S )	zCExtract Telegram usernames (starting with @) from the convert page.r4   z@[a-zA-Z0-9_]{5,32}r5   r7   Tr;   r8   z'.username, .tm-username, .user, .handle)	r    rC   r?   rD   rE   rF   rG   râ€”   rR   )
r3   rS   rT   rU   rV   rY   r8   r[   rW   r]   r\   r   r   r   Ãš_parse_usernames_from_htmlÃš   s$   
Ã¼ rÂ°   Ãºhttps://fragment.com/convertc              
   C   sb  |pt Æ’ }t| Æ’}	tÂ Â¡ }
|
jÂ |	Â¡ |ddddÅ“}
d}d}
ddd dÅ“}||k Âr|d	7 }||d
< zÂ«| r;tÂ  d
||Â¡ |
j||
|d|d
Â}|j	|d< |j	dkrb|j
Â dÂ¡}d|â€º Â|d< t
|d Æ’â€š|j	dv rud|j	â€º Â|d< t|d Æ’â€š|j	dkrÂ¥|j
}d|jÂ Â¡ v sÂd|Â Â¡ v rËœd|Â Â¡ v rËœd|d< tdÆ’â€št|Æ’}d|d< ||fW S d|j	  krÂ°dk rÃn n|d|d	   tÂ Â¡ d  }tÂ d |j	|Â¡ tÂ |Â¡ W q$d!|j	â€º Â|d< t|d Æ’â€š tttfÂy } z#|}
|d|d	   tÂ Â¡ d  }tÂ d"|||Â¡ tÂ |Â¡ W Y d}~q$d}~ww d#|â€º d$Â|d< |
Âr%td%|â€º d&|
â€º ÂÆ’â€štd%|â€º d'|d â€º ÂÆ’â€š)(zÃ‹
    Fetch and return list of usernames (@...) from fragment.com/convert.

    Returns:
        (usernames_list, meta)
    Raises:
        FragmentAuthError, FragmentRateLimitError, RequestException
    rm   rn   ro   rp   r   Nr>   ru   r9   rv   ry   Trz   rw   r~   r   râ‚¬   rx   rÆ’   râ€   râ€¦   rË†   râ€¡   râ€¹   zDetected login pagezCookies expired or invalid.rÅ’   rÂ   rÅ½   rÂ   râ€š   rÂ   zUnexpected HTTP rÂ   râ€˜   râ€™   râ€œ   râ€   z attempts, last code )r2   r1   râ€¢   râ€“   r0   râ€”   rËœ   râ„¢   rÅ¡   râ€º   r{   r   r   rY   rf   rÂ    rÂ°   rÅ“   rÂ   rÅ¾   rÅ¸   r   r
   r	   r
   )re   rf   rg   rh   ri   rj   rk   rl   rÂ¢   r0   rÂ£   r{   rÂ¤   rÂ¥   rÂ¦   rÂ§   rÂ¨   rÂ«   Ãš	usernamesrÂª   rÂ®   r   r   r   Ãšget_fragment_usernamesÃ¶   sl   
Ã¼ 




&


â‚¬Ã» rÂ³   Ãšnumberc           
      C   sÂ¬   t |Æ’}tÂ Â¡ }|jÂ |Â¡ | Â ddÂ¡Â ddÂ¡}d|â€º dÂ}|j|dd Â}|j dkr2td	|j â€º ÂÆ’â€št	|j
d
Æ’} | j
d
dd
Â}|rT|jddÂ}	t
Â d|	Â¡}
|
rT|
Â dÂ¡S dS )z?Fetch the login code for a given +888 number from fragment.com.r:   r>   r5   Ãºhttps://fragment.com/number/z/coderb   )rg   râ€¦   z Failed to fetch code page: HTTP r4   Ãšdivztm-number-code-field)Ãšclass_Tr;   z\d+r   N)r1   râ€¢   râ€“   r0   râ€”   Ãš replacerÅ¡   râ€º   Ãš	Exceptionr    rY   ÃšfindrE   r?   rH   rI   )
rÂ´   re   r0   rÂ£   Ãšnum_pathrf   rÂ§   rS   Ãšcode_divÃš	code_textrU   r   r   r   Ãšget_login_codeL  s    

rÂ¾   c                 C   sr   t |Æ’}tÂ Â¡ }|jÂ |Â¡ | Â ddÂ¡Â ddÂ¡}d}d|dd dÅ“}|j||d	d
Â} | j d
kr7| Â Â¡ Â 	dÂ¡r7d
S dS )Nr:   r>   r5   Ãºhttps://fragment.com/apiÃšsetPhoneFlagÃš
receive_codesÃšfalse)ÃšmethodrÂ´   Ãšflagr$   rb   Â©Ãšdatarg   râ€¦   ÃšokTF)
r1   râ€¢   râ€“   r0   râ€”   rÂ¸   Ãšpostrâ€º   r,   rÅ¡   )rÂ´   re   r0   rÂ£   rÂ»   rf   ÃšformdatarÂ§   r   r   r   Ãšdisable_receive_login_codesd  s   Ã¼ rÃŠ   c           
      C   sÅ¡   t |Æ’}tÂ Â¡ }|jÂ |Â¡ | Â ddÂ¡Â ddÂ¡}d}d|dÅ“}|j||d dÂ} | Â  Â¡ }|Â d	Â¡s4t	d
Æ’â€š|Â d
Â¡}	|	|d
< |j||d dÂ} | Â  Â¡ Â dd
Â¡S )z3Terminate all active sessions for the given number.r:   r>   r5   rÂ¿   ÃšterminatePhoneSessions)rÃƒ   rÂ´   rb   rÃ…   rÃ‡   zFailed to start terminationÃšterminate_hashrÂ©   z
No message)
r1   râ€¢   râ€“   r0   râ€”   rÂ¸   rÃˆ   r,   rÅ¡   rÂ¹   )
rÂ´   re   r0   rÂ£   rÂ»   rf   rÃ‰   rÂ§   rÃ†   rÃŒ   r   r   r   Ãšterminate_all_sessionsw  s    Ã¾

rÃ   c                
   @   sR   e Zd ZdZdededededd f
dd	â€Zd
edefd
dâ€Z d
edefddâ€Z	d S )Ãš
FragmentAPIrÂ¿   Ãšhashrâ€°   Ãšstel_ton_tokenrÅ    r   Nc                 C   s>   t d|idddddd dd	d
d
|â€º d|â€º d
|â€º ÂdÅ“
dÂ| _d S )NrÃ   zFMozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0z.application/json, text/javascript, */*; q=0.01zen-US,en;q=0.5zgzip, deflate, br, zstdz0application/x-www-form-urlencoded; charset=UTF-8ÃšXMLHttpRequestzhttps://fragment.comz
keep-alivera   z
stel_ssid=z; stel_dt=-300; stel_ton_token=z
; stel_token=)
rq   rr   rs   zAccept-EncodingzContent-TypezX-Requested-WithÃšOriginÃš
Connectionrt   ÃšCookie)Ãšparamsr{   )r   Ãšclient)ÃšselfrÃ   râ€°   rÃ   rÅ    r   r   r   Ãš__init__â€“  s   Ã¿Ã¶Ã¼zFragmentAPI.__init__rÃ†   c                 Ãƒ   sH   Â| j j| j|dÂI d H }|Â Â¡ }d|v r"td|d â€º d|â€ºdÂÆ’â€š|S )N)rf   rÃ†   ÃšerrorzFragment API error: z (request = Ãº))rÃ–   rÃˆ   ÃšBASE_URLr,   rÂ¹   )rÃ—   rÃ†   ÃšresponseÃš
response_datar   r   r   Ãš_requestÂ©  s   â‚¬Ã¾zFragmentAPI._requestrÂ´   c                 Ãƒ   s,   Â| j d|dddÅ“dÂI d H }|Â dÂ¡d kS )NÃ©   ÃštrueÃš
canSellItem)ÃštypeÃšusernameÃš auctionrÃƒ   )rÃ†   Ãšconfirm_buttonzProceed anyway)rÃ   rÅ¡   )rÃ—   rÂ´   rÃ   r   r   r   Ãšcheck_is_number_freeÂ¶  s   â‚¬Ã¼Ã¿	z FragmentAPI.check_is_number_free)
r   r   r   rÃ›   rQ   rÃ˜   ÃšDATA_TrÃ   ÃšboolrÃ¦   r   r   r   r   rÃ   â€œ  s
    
rÃ   c                    s`   t | dddÂÂ
}tÂ |Â¡}W d  Æ’ n1 sw   Y  ddâ€ |D Æ’â€° g d Â¢}â€¡ fddâ€|D Æ’S )	zÃ¬
    Extract key Fragment cookies (stel_ssid, stel_ton_token, stel_token, stel_dt) 
    from a cookies JSON file exported by the browser.

    Returns:
        dict with cookie names as keys and their values (or None if not found).
    r   r   r   Nc                 S   r!   r"   r   r%   r   r   r   r(   Ã  r)   z+extract_fragment_tokens.<locals>.<dictcomp>)râ€°   rÃ   rÅ    Ãš stel_dtc                    s   i | ]}|Ë† Â  |Â¡â€œqS r   )rÅ¡   )r&   ÃškÂ©r0   r   r   r(   Ã’  s    r*   )r   r.   r/   Ãš	importantr   rÃ«   r   Ãšextract_fragment_tokensÃƒ  s   Ã¿rÃ­   râ€°   rÃ   rÅ    )rÃ   râ€°   rÃ   rÅ    c                  C   sÃ¸   |pt Æ’ }t| Æ’}tÂ Â¡ } | jÂ |Â¡ |ddddÅ“}dddd Å“}	g }
t| ||||dÂ\}
}|
D ]@}
|
Â  d	dÂ¡Â  d
dÂ¡}d
|â€º Â}|rHtÂ 	d|Â¡ | j
||||d
Â}|	d  d7  < |j
dkr_q/t|j
dÆ’}|Â dÂ¡ro|
Â |
Â¡ q/t|
Æ’|	d< d|	d< |
S )Nrm   rn   ro   rp   r   r>   )Ãš checkedÃš
restrictedrx   )re   rg   rj   rk   rl   r:   r5   rÂµ   z
Checking %s)r{   rg   r}   rÃ®   r9   râ€¦   r4   z+blockquote.tm-section-blockquote.tm-warningrÃ¯   rÅ’   rx   )r2   r1   râ€¢   râ€“   r0   râ€”   rÂ¯   rÂ¸   rËœ   râ„¢   rÅ¡   râ€º   r    rY   Ãš
select_oneÃšappendÃšlen)re   rg   rj   rk   rl   rÂ¢   r0   rÂ£   r{   rÂ¦   Ãšrestricted_numbersrÂ­   Ãš_rX   rÂ»   rf   rÂ§   rS   r   r   r   Ãšget_restricted_numbersÃœ  sD   
Ã¼ 
Ã»



â‚¬rÃµ   )r   )r   ra   rb   rc   rd   NTF)r   rÂ±   rb   rc   rd   NTF)r   rb   NTF)1r,   rÅ¾   rÅ“   Ãš loggingr?   Ãštypingr   r   r   r   Ãšhttpxr   râ€¢   Ãšbs4r    Ãšrequests.exceptionsr   r	   r
   r
   ÃšFRAGMENT_API_HASHÃšdictrQ   ÃšintrÃ§   Ãš	getLoggerr   rËœ   ÃšhandlersÃš
basicConfigÃšINFOrÂ¹   r   r   r1   r2   r`   ÃšfloatrÃ¨   rÂ¯   rÂ°   rÂ³   rÂ¾   rÃŠ   rÃ   rÃ   rÃ­   Ãšfragment_apirÃµ   r   r   r   r   Ãš<module>   sÃ   
 0Ã¸Ã¿Ã¾Ã½Ã¼Ã»Ãº Ã¹Ã¸	
Ã·zÃ¸Ã¿Ã¾Ã½Ã¼Ã»Ãº Ã¹Ã¸	
Ã·V 0


Ã¼Ã»Ã¿Ã¾Ã½Ã¼Ã»Ãº
