o
    }Ã“hÃ¡4  Ã£                
   @   s,  d dl mZ d dlZd dlmZmZmZ d dlm Z  eejÆ’Z	e	d Z
e
d Z
e
d  Ze
d Z
e
d	 Ze
d Ze
d
 Ze
d
 Ze
d Ze
d
 Ze
d Ze
d Ze
d Ze Æ’ dfdededededef
ddâ€Zdefddâ€Zdefddâ€Zdedefddâ€Zdefdd â€Zdeded!edefd"d#â€Zdefd$d%â€Z defd&d'â€Z!defd(d)â€Z"defd*d+â€Z#d,d-â€ Z$ded.e%eB fd/d0â€Z&defd1d2â€Z'd3d4â€ Z(defd5d6â€Z)defd7d8â€Z*defd9d:â€Z+d;d<â€ Z,duded>e%d?e%d@e%dAef
dBdCâ€Z-defdDdEâ€Z.dedFe/eB fdGdHâ€Z0dedIefdJdKâ€Z1defdLdMâ€Z2dedNefdOdPâ€Z3defdQdRâ€Z4dvd
edIefdTdUâ€Z5dvdIedFefdVdWâ€Z6dedefdXdYâ€Z7dZd[â€ Z8defd\d]â€Z9defd^d_â€Z:d`edefdadbâ€Z;d`edFe/eB fdcddâ€Z<d`efdedfâ€Z=e Æ’ fdefdgdhâ€Z>didjâ€ Z?defdkdlâ€Z@defdmdnâ€ZAdodpâ€ ZBdqdrâ€ ZCdsdtâ€ ZDdS )wÃ©    )Ãš
MongoClientN)ÃšdatetimeÃštimezoneÃš	timedelta)Ãšget_current_datetimeÃšuserdbÃšusersÃšadminsÃš numbersÃš	languagesÃšrulesÃš rentalsÃš	deletionsÃš tron_txÃšrestricted_numbersÃšrestricted_toggleÃšpayment_methodsFÃšnumberÃš user_idÃšhoursÃšdateÃšextendc                  C   sâ‚¬   | Â  dÂ¡sd| Â dÂ¡ } tÂ || dÅ“Â¡}|r*|sdS tÂ || dÅ“d||dÅ“iÂ¡ d S |}tjd|id	d
| ||d
Å“iidd
Â dS )u  Save or extend a number for a user.

    - If the number exists and extend=False Ã¢â€ â€™ return False, "ALREADY"
    - If the number exists and extend=True Ã¢â€ â€™ update hours Ã¢â€ â€™ return True, "UPDATED"
    - If the number doesn't exist Ã¢â€ â€™ insert Ã¢â€ â€™ return True, "SAVED"
    Ãº+888Ãº+)r   Ãºnumbers.numberÂ©FÃš ALREADYÃº$set)znumbers.$.hoursznumbers.$.dateÂ©TÃš UPDATEDr   z$pushr
   )r   r   r   TÂ©ÃšupsertÂ©TÃšSAVED)Ãš
startswithÃšlstripÃš	users_colÃšfind_oneÃš
update_one) r   r   r   r   r   ÃšexistingÃšnowÂ© r+   Ãº2/mnt/c/Users/LENOVO/RentalBot/hybrid/plugins/db.pyÃš
save_number   s(   
 Ã¿Ã¾Ã½r-   c                 C   s`   | Â  dÂ¡sd| Â dÂ¡ } tÂ d| idddÅ“Â¡}|r.d|v r.|d d  }|d |d	 |d
 fS d
S )z#Get user_id, hours, date by number.r   r   r   Ã©   )r   z	numbers.$r
   r   r   r   r   F)r$   r%   r&   r'   )r   ÃšrecordÃšnumr+   r+   r,   Ãšget_user_by_number9   s   
Ã¾r1   c                 C   s2   t Â d| iddiÂ¡}|sg S ddâ€ |Â dg Â¡D Æ’S )Nr   r
   r.   c                 S   s.   g | ]}t |tÆ’rd |v r|d  nt|Æ’â€˜qS Â©r   )Ãš
isinstanceÃšdictÃšstr)Ãš.0Ãšnr+   r+   r,   Ãš
<listcomp>K   s   . z'get_numbers_by_user.<locals>.<listcomp>Â©r&   r'   ÃšgetÂ©r   r/   r+   r+   r,   Ãšget_numbers_by_userG   s   r<   c                  C   sB   | Â  dÂ¡sd| Â dÂ¡ } tÂ d|iddd| iiiÂ¡}|jrd S dS )	z#Remove a number from a user's list.r   r   r   z$pullr
   r   Â©TÃš REMOVEDÂ©FÃš	NOT_FOUND)r$   r%   r&   r(   Ãšmodified_count)r   r   Ãšresultr+   r+   r,   Ãš
remove_numberM   s   
Ã¾rC   c           	      C   s`   t | Æ’}|sdS |\}}}tÆ’ }|| }|Â Â¡ d } ||  }tdt|d Æ’Æ’tdt|d Æ’Æ’fS )z>Return remaining rent days for a number, or None if not found.Ni  r   Ã©   )r1   r   Ãš
total_secondsÃšmaxÃšint)	r   Ãš	user_datar   r   Ãš
rented_dater*   Ãš elapsedÃš
elapsed_hoursÃšremaining_hoursr+   r+   r,   Ãšget_remaining_rent_daysX   s   
$rM   Ãš	rent_datec                 C   s<   t |Æ’}|t|dÂ }tjd| id||||dÅ“iddÂ d S )z2
    Save or update rental data for a number.
    )r   r   r   )r   rN   r   Ãš
expiry_dateTr    N)rG   r   Ãš
rental_colr(   )r   r   rN   r   rO   r+   r+   r,   Ãšsave_number_datag   s   Ã¼
Ã¸rQ   c                 C   s   t Â d| iÂ¡S )zF
    Get saved data for a number.
    Returns None if not rented.
    r   )rP   r'   r2   r+   r+   r,   Ãšget_number_datax   s   rR   c                 C   s   t Â d| iÂ¡}ddâ€ |D Æ’S )z3
    Returns list of numbers rented by a user.
    r   c                 S   Ã³   g | ]
}d |v r|d  â€˜qS r2   r+   Â©r6   Ãšdocr+   r+   r,   r8   â€   Ã³    z$get_user_numbers.<locals>.<listcomp>)rP   Ãšfind)r   Ãšrentedr+   r+   r,   Ãšget_user_numbers   Ã³   rY   c                 C   Ã³   t Â d| iÂ¡}|jrdS dS )z*
    Remove rental data for a number.
    r   r=   r?   )rP   Ãš
delete_oneÃš
deleted_countÂ©r   rB   r+   r+   r,   Ãšremove_number_dataâ€    rZ   r_   c                 C   s(   t Â d| iÂ¡r	dS t Â | g ddÅ“Â¡ dS )Nr   )FÃšEXISTSr   )r   r
   Ãš balancer"   )r&   r'   Ãš
insert_oneÂ©r   r+   r+   r,   Ãšsave_user_idÂ   s   rd   c                   C   s
   t Â dÂ¡S )zReturn all user IDs in DB.r   )r&   Ãšdistinctr+   r+   r+   r,   Ãšget_all_user_idsâ€¢   s   
rf   ra   c                 C   s.   t jd| idd|iiddÂ}|jdkrd S dS )	z]
    Replace the user's balance with a new value.
    Always overwrites the old balance.
    r   r   ra   Tr    r   Ãš CREATEDr   )r&   r(   Ãš
matched_count)r   ra   rB   r+   r+   r,   Ãšsave_user_balanceâ€º   s   
Ã½ri   c                 C   s&   t Â d| iddiÂ¡}|r|Â dÂ¡S dS )zGet a user's balance.r   ra   r.   Nr9   r;   r+   r+   r,   Ãšget_user_balanceÂ§   Ã³   rj   c                  C   sV   ddddiiiddd did d	id
Å“ig} t tÂ | Â¡Æ’}|r)|d
 d |d
 d
 fS dS )zn
    Return the total balance of all users combined
    and the number of users who have a balance field.
    z$matchra   z $existsTz$groupNz$sumz$balancer.   )Ãš_idÃš
total_balanceÃš
user_countr   rm   rn   )g        r   )Ãšlistr&   Ãš	aggregate)ÃšpipelinerB   r+   r+   r,   Ãšget_total_balanceÂ¬   s   Ã¾rr   c                 C   s$   t Â d| iÂ¡r	dS t Â d| iÂ¡ dS )Nr   r   )TÃšADDED)Ãš
admins_colr'   rb   rc   r+   r+   r,   Ãš	add_adminÂ½   s   ru   c                 C   r[   )Nr   r=   r?   )rt   r\   r]   )r   rB   r+   r+   r,   Ãšremove_adminÃƒ   Ã³   rv   c                 C   s   t Â d| iÂ¡d uS )Nr   )rt   r'   rc   r+   r+   r,   Ãšis_adminÃ‡   s   rx   c                  C   Ã³    t Â i dddÅ“Â¡} ddâ€ | D Æ’S )Nr   r.   )rl   r   c                 S   s   g | ]}|d  â€˜qS rc   r+   )r6   Ãšar+   r+   r,   r8   ÃŒ   s    z"get_all_admins.<locals>.<listcomp>)rt   rW   )r	   r+   r+   r,   Ãšget_all_adminsÃŠ   Ã³   r{   TÃšprice_30Ãšprice_60Ãšprice_90Ãš	availablec                  C   sd   | Â  dÂ¡sd| Â dÂ¡ } | |||dÅ“ddddÅ“|tÆ’ d Å“}tjd| id	|id
d
Â}|jdkr0d
S dS )zECreate or update number details with rates & hours for 30/60/90 days.r   r   )Ãš30dÃš60dÃš90diÃ  iÂ   ip  )r   Ãšpricesr   râ‚¬   Ãš
updated_atr   r   Tr    r   rg   r   )r$   r%   r   Ãš
number_colr(   rh   ) r   r}   r~   r   râ‚¬   ÃšdatarB   r+   r+   r,   Ãšsave_number_infoÃ   s(   
Ã½Ã½Ã³Ã½rË†   c                 K   sâ€“   | Â  dÂ¡sd| Â dÂ¡ } i }d|v r|d |d< d|v r"|d |d< d |v r,|d  |d< d	|v r6|d	 |d	< |s:d
S tÆ’ |d
< tÂ d| id
|iÂ¡ dS )zv
    Edit specific details of a number.
    Example: edit_number_info("+88812345", price_30=120, available=False)
    r   r   r}   z
prices.30dr~   z
prices.60dr   z
prices.90drâ‚¬   )FÃš
NO_CHANGESrâ€¦   r   r   r   )r$   r%   r   râ€    r(   )r   ÃškwargsÃš updatesr+   r+   r,   Ãšedit_number_infoÃ¬   s    

rÅ’   Ãšreturnc                 C   s8   | Â  dÂ¡sd| Â dÂ¡ } tÂ d| iddiÂ¡}|r|S dS ) z:Return all data for a given number, or False if not found.r   r   r   rl   r   F)r$   r%   râ€    r'   Â©r   r/   r+   r+   r,   Ãšget_number_info  s   
rÂ   Ãšlangc                 C   Ã³    t jd| idd|iiddÂ d S )Nr   r   ÃšlanguageTr    )Ãšlang_colr(   )r   rÂ   r+   r+   r,   Ãšsave_user_language  Ã³    râ€   c                 C   s    t Â d| iÂ¡}|r|Â dÂ¡S d S )Nr   râ€™   )râ€œ   r'   r:   Â©r   Ãšuserr+   r+   r,   Ãšget_user_language  Ã³   rËœ   Ãšmethodc                 C   râ€˜   )Nr   r   Ãšpayment_methodTr    )Ãš
payment_colr(   )r   rÅ¡   r+   r+   r,   Ãšsave_user_payment_method  râ€¢   rÂ   c                 C   s    t Â d| iÂ¡}|r|Â dÂ¡S dS )Nr   râ€º   Ãš	cryptobot)rÅ“   r'   r:   râ€“   r+   r+   r,   Ãšget_user_payment_method  râ„¢   rÅ¸   Ãšenc                 C   s(   t jdd|â€º Âid| |dÅ“iddÂ d S )z6Save or update the rules text for a specific language.rl   Ãšrules_r   )Ãštextrâ€™   Tr    N)Ãš	rules_colr(   )r   rÂ   r+   r+   r,   Ãš
save_rules!  s
   
Ã½rÂ¤   c                 C   s&   t Â dd| â€º ÂiÂ¡}|r|Â dÂ¡S dS )z1Get the saved rules text for a specific language.rl   rÂ¡   rÂ¢   z
No rules set.)rÂ£   r'   r:   )rÂ   r/   r+   r+   r,   Ãš	get_rules)  rk   rÂ¥   c                 C   s    t jd| idd|iiddÂ dS ) z2Mark a number as scheduled for deletion in 7 days.r   r   Ãš
deletion_dateTr    N)Ãšdelaccolr(   Â©r   r   r+   r+   r,   Ãšsave_7day_deletion0  s
   

Ã½rÂ©   c                  C   s&   t Æ’ } tÂ dd| iiÂ¡}ddâ€ |D Æ’S )z.Return list of numbers scheduled for deletion.rÂ¦   z$ltec                 S   rS   r2   r+   rT   r+   r+   r,   r8   <  rV   z&get_7day_deletions.<locals>.<listcomp>)r   rÂ§   rW   )r*   r   r+   r+   r,   Ãšget_7day_deletions8  s   rÂª   c                 C   s"   t Â d| idddiiÂ¡}|jdkS )z,Remove the deletion_date field for a number.r   z$unsetrÂ¦   Ãš r   )rÂ§   r(   rA   r^   r+   r+   r,   Ãšremove_7day_deletion>  s
   
Ã¾
rÂ¬   c                 C   s.   t Â d| iddiÂ¡}|rd|v r|Â dÂ¡S dS )z-Get the scheduled deletion date for a number.r   rÂ¦   r.   N)rÂ§   r'   r:   rÅ½   r+   r+   r,   Ãš
get_7day_dateF  s   rÂ­   Ãš tx_hashc                 C   Ã³&   t Â d| iÂ¡r	dS t Â | |dÅ“Â¡ dS )NrÂ®   r   Â©rÂ®   r   r"   )Ãš troncolr'   rb   rÂ°   r+   r+   r,   Ãšsave_tron_tx_hashM  s   Ã¾rÂ²   c                 C   s   t Â d| iddiÂ¡S )zGet a Tron transaction hash.rÂ®   rl   r   )rÂ±   r'   )rÂ®   r+   r+   r,   Ãšget_tron_tx_hashV  s   rÂ³   c                 C   r[   )NrÂ®   r=   r?   )rÂ±   r\   r]   )rÂ®   rB   r+   r+   r,   Ãšremove_tron_tx_hashZ  rw   rÂ´   c                 C   rÂ¯   )Nr   r   rÂ¨   r"   )Ãš
restrictedcolr'   rb   rÂ¨   r+   r+   r,   Ãšsave_restricted_number_  s   rÂ¶   c                  C   ry   )Nr   r.   )rl   r   c                 S   rS   r2   r+   )r6   Ãšrr+   r+   r,   r8   g  rV   z*get_restricted_numbers.<locals>.<listcomp>)rÂµ   rW   )Ãš
restrictedr+   r+   r,   Ãšget_restricted_numberse  r|   rÂ¹   c                 C   r[   )Nr   r=   r?   )rÂµ   r\   r]   r^   r+   r+   r,   Ãšremove_restricted_numberi  rw   rÂº   c                 C   s.   t Â d| iddiÂ¡}|rd|v r|Â dÂ¡S d S )Nr   r   r.   )rÂµ   r'   r:   rÅ½   r+   r+   r,   Ãšget_rest_num_datem  s   rÂ»   c                  C   sP   t Â ddiÂ¡} | r| Â ddÂ¡ }t Â ddidd|iiÂ¡ |S t Â ddd Å“Â¡ dS )z7Toggle for Delete restricted numbers older than 3 days.rl   Ãšrest_del_toggleÃš enabledFr   T)rl   rÂ½   )Ãšrest_toggle_colr'   r:   r(   rb   )ÃštoggleÃš	new_stater+   r+   r,   Ãšrestricted_del_toggleq  s   rÃ   c                  C   s"   t Â ddiÂ¡} | r| Â ddÂ¡S dS )Nrl   rÂ¼   rÂ½   F)rÂ¾   r'   r:   )rÂ¿   r+   r+   r,   Ãšis_restricted_del_enabled|  s   rÃ‚   c                   C   s|   t Â i Â¡ tÂ i Â¡ tÂ i Â¡ tÂ i Â¡ tÂ i Â¡ tÂ i Â¡ t Â i Â¡ tÂ i Â¡ t	Â i Â¡ t
Â i Â¡ t
Â i Â¡ tÂ i Â¡ dS )N)TzALL DATA DELETED)
r&   Ãš
delete_manyrt   râ€    râ€œ   Ãš
numbers_colrÂ£   rP   rÂ§   rÂ±   rÂµ   rÂ¾   rÅ“   r+   r+   r+   r,   Ãšdelete_all_dataÆ’  s   











rÃ…   )T)rÂ    )EÃš pymongor   Ãšconfigr   r   r   Ãšhybrid.plugins.funcr   ÃšDB_URIÃšclientÃšdbr&   rt   râ€    râ€œ   rÃ„   rÂ£   rP   rÂ§   rÂ±   rÂµ   rÂ¾   rÅ“   r5   rG   Ãšboolr-   r1   r<   rC   rM   rQ   rR   rY   r_   rd   rf   Ãšfloatri   rj   rr   ru   rv   rx   r{   rË†   rÅ’   r4   rÂ   râ€   rËœ   rÂ   rÅ¸   rÂ¤   rÂ¥   rÂ©   rÂª   rÂ¬   rÂ­   rÂ²   rÂ³   rÂ´   rÂ¶   rÂ¹   rÂº   rÂ»   rÃ   rÃ‚   rÃ…   r+   r+   r+   r,   Ãš<module>   sv   
& 
  	 
  	
 
